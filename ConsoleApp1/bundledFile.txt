// Author: John Doe
// Source: obj\Debug\net8.0\.NETCoreApp,Version=v8.0.AssemblyAttributes.cs
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v8.0", FrameworkDisplayName = ".NET 8.0")]
// Source: obj\Release\net8.0\.NETCoreApp,Version=v8.0.AssemblyAttributes.cs
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v8.0", FrameworkDisplayName = ".NET 8.0")]
// Source: obj\Debug\net8.0\ConsoleApp1.AssemblyInfo.cs
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
using System;
using System.Reflection;
[assembly: System.Reflection.AssemblyCompanyAttribute("ConsoleApp1")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("ConsoleApp1")]
[assembly: System.Reflection.AssemblyTitleAttribute("ConsoleApp1")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]
// Generated by the MSBuild WriteCodeFragment class.
// Source: obj\Debug\net8.0\ConsoleApp1.GlobalUsings.g.cs
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
// Source: obj\Debug\net8.0\fib.AssemblyInfo.cs
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
using System;
using System.Reflection;
[assembly: System.Reflection.AssemblyCompanyAttribute("fib")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("fib")]
[assembly: System.Reflection.AssemblyTitleAttribute("fib")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]
// Generated by the MSBuild WriteCodeFragment class.
// Source: obj\Release\net8.0\fib.AssemblyInfo.cs
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
using System;
using System.Reflection;
[assembly: System.Reflection.AssemblyCompanyAttribute("fib")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Release")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("fib")]
[assembly: System.Reflection.AssemblyTitleAttribute("fib")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]
// Generated by the MSBuild WriteCodeFragment class.
// Source: obj\Debug\net8.0\fib.GlobalUsings.g.cs
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
// Source: obj\Release\net8.0\fib.GlobalUsings.g.cs
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
// Source: Program.cs
/*using System.CommandLine;
var bundleOptions = new Option<FileInfo>("--output", "file path and name");
var bundleCommand = new Command("bundle", "Bundle Code File To A Signal File");
bundleCommand.AddOption(bundleOptions);
bundleCommand.SetHandler((output) =>
{
    try
    {
        File.Create(output.FullName);
        Console.WriteLine("file was created");
    }
    catch (DirectoryNotFoundException ex)
    {
        Console.WriteLine("Error: file path is invalid");
    }
}, bundleOptions);
var rootCommand = new RootCommand("Root Command For File Bundler CLI");
rootCommand.AddCommand(bundleCommand);
rootCommand.InvokeAsync(args);
*/
using System.CommandLine;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
var languageOption = new Option<string[]>(
    "--language",
    "List of programming languages (comma-separated) or 'all'. This option is required.")
{ IsRequired = true };
var outputOption = new Option<FileInfo>(
    "--output",
    "File path and name for the bundled file")
{ IsRequired = true };
var noteOption = new Option<bool>(
    "--note",
    "Include the source file's relative path as a comment in the bundle");
var sortOption = new Option<string>(
    "--sort",
    () => "name",  // ברירת המחדל תהיה לפי שם הקובץ
    "Sort files by 'name' or 'type'");
var removeEmptyLinesOption = new Option<bool>(
    "--remove-empty-lines",
    "Remove empty lines from the source code files");
var authorOption = new Option<string>(
    "--author",
    "Specify the author's name to include as a comment in the bundle file");
var bundleCommand = new Command("bundle", "Bundle Code Files into a Single File");
bundleCommand.AddOption(languageOption);
bundleCommand.AddOption(outputOption);
bundleCommand.AddOption(noteOption);
bundleCommand.AddOption(sortOption);
bundleCommand.AddOption(removeEmptyLinesOption);
bundleCommand.AddOption(authorOption);
bundleCommand.SetHandler((string[] languages, FileInfo output, bool note, string sort, bool removeEmptyLines, string author) =>
{
    try
    {
        // בודק אם המשתמש בחר "all" או רשימה של שפות
        var allLanguages = languages.Contains("all");
        // מוצא את כל קבצי הקוד בתיקיה
        var files = Directory.GetFiles(Directory.GetCurrentDirectory(), "*.*", SearchOption.AllDirectories)
                              .Where(file =>
                                  allLanguages || languages.Contains(Path.GetExtension(file).TrimStart('.')))
                              .ToList();
        // מסדר את הקבצים לפי אופציה שנבחרה
        if (sort == "type")
        {
            files = files.OrderBy(Path.GetExtension).ToList();  // לפי סוג הקובץ
        }
        else
        {
            files = files.OrderBy(Path.GetFileName).ToList();  // לפי א"ב של שם הקובץ
        }
        using var writer = new StreamWriter(output.FullName);
        // כותב את שם היוצר אם סופק
        if (!string.IsNullOrWhiteSpace(author))
        {
            writer.WriteLine($"// Author: {author}");
        }
        // כותב את הקבצים לקובץ הפלט
        foreach (var file in files)
        {
            if (note)
            {
                // אם האופציה 'note' נבחרה, מוסיף את נתיב הקובץ כהערה
                writer.WriteLine($"// Source: {Path.GetRelativePath(Directory.GetCurrentDirectory(), file)}");
            }
            var lines = File.ReadAllLines(file);
            if (removeEmptyLines)
            {
                // אם האופציה 'remove-empty-lines' נבחרה, מסיר שורות ריקות
                lines = lines.Where(line => !string.IsNullOrWhiteSpace(line)).ToArray();
            }
            foreach (var line in lines)
            {
                writer.WriteLine(line);
            }
        }
        Console.WriteLine($"Bundled {files.Count} files into {output.FullName}");
    }
    catch (DirectoryNotFoundException ex)
    {
        Console.WriteLine("Error: file path is invalid");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error: {ex.Message}");
    }
}, languageOption, outputOption, noteOption, sortOption, removeEmptyLinesOption, authorOption);
var rootCommand = new RootCommand("Root Command For File Bundler CLI");
rootCommand.AddCommand(bundleCommand);
// הרצת הפקודה
await rootCommand.InvokeAsync(args);
